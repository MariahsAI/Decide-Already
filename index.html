<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DecideAlready</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700;900&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Space Grotesk', sans-serif; overflow-x: hidden; }
    
    .animated-bg {
      background: linear-gradient(-45deg, #0d0015, #1a0a2e, #0f0a1f, #150825, #0a0612);
      background-size: 400% 400%;
      animation: gradientShift 15s ease infinite;
    }
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    .particles { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: hidden; z-index: 0; }
    .particle { position: absolute; width: 4px; height: 4px; border-radius: 50%; animation: float 20s infinite; }
    .particle-pink { background: rgba(247, 37, 133, 0.6); box-shadow: 0 0 10px rgba(247, 37, 133, 0.4); }
    .particle-blue { background: rgba(76, 201, 240, 0.6); box-shadow: 0 0 10px rgba(76, 201, 240, 0.4); }
    @keyframes float {
      0%, 100% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { transform: translateY(-100vh) rotate(720deg); opacity: 0; }
    }
    
    .glow-pink { box-shadow: 0 0 20px rgba(247, 37, 133, 0.5), 0 0 40px rgba(247, 37, 133, 0.3), 0 0 60px rgba(247, 37, 133, 0.1); }
    .glow-blue { box-shadow: 0 0 20px rgba(76, 201, 240, 0.5), 0 0 40px rgba(76, 201, 240, 0.3); }
    .glow-text { text-shadow: 0 0 20px rgba(247, 37, 133, 0.8), 0 0 40px rgba(247, 37, 133, 0.4), 0 0 80px rgba(247, 37, 133, 0.2); }
    .glow-text-blue { text-shadow: 0 0 20px rgba(76, 201, 240, 0.8), 0 0 40px rgba(76, 201, 240, 0.4); }
    
    .btn-hover { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .btn-hover:hover { transform: translateY(-2px) scale(1.02); box-shadow: 0 10px 40px rgba(247, 37, 133, 0.4); }
    .btn-hover:active { transform: translateY(0) scale(0.98); }
    
    .card-enter { animation: cardEnter 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
    @keyframes cardEnter { from { opacity: 0; transform: translateY(30px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
    
    .shake { animation: shake 0.5s cubic-bezier(0.36, 0.07, 0.19, 0.97); }
    @keyframes shake { 10%, 90% { transform: translateX(-1px); } 20%, 80% { transform: translateX(2px); } 30%, 50%, 70% { transform: translateX(-4px); } 40%, 60% { transform: translateX(4px); } }
    
    .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    
    .streak-glow { animation: streakPulse 2s ease-in-out infinite; }
    @keyframes streakPulse {
      0%, 100% { box-shadow: 0 0 20px rgba(76, 201, 240, 0.3), inset 0 0 20px rgba(76, 201, 240, 0.05); }
      50% { box-shadow: 0 0 40px rgba(76, 201, 240, 0.6), 0 0 60px rgba(76, 201, 240, 0.3), inset 0 0 30px rgba(76, 201, 240, 0.1); }
    }
    
    .option-btn { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .option-btn:hover { transform: translateY(-4px); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3), 0 0 20px rgba(247, 37, 133, 0.2); border-color: rgba(247, 37, 133, 0.5); }
    
    .confetti { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1000; }
    .confetti-piece { position: absolute; width: 10px; height: 10px; animation: confettiFall 3s ease-out forwards; }
    @keyframes confettiFall { 0% { transform: translateY(-100px) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
    
    .celebration-overlay { animation: celebrationPop 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
    @keyframes celebrationPop { 0% { transform: translate(-50%, -50%) scale(0); } 50% { transform: translate(-50%, -50%) scale(1.1); } 100% { transform: translate(-50%, -50%) scale(1); } }
    
    .reveal-text { animation: revealText 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
    @keyframes revealText { 0% { opacity: 0; transform: scale(0.8); filter: blur(10px); } 100% { opacity: 1; transform: scale(1); filter: blur(0); } }
    
    .glass-card { background: rgba(20, 10, 40, 0.6); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(247, 37, 133, 0.2); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), inset 0 0 60px rgba(247, 37, 133, 0.03); }
    
    .animated-border { position: relative; background: linear-gradient(135deg, rgba(247, 37, 133, 0.15), rgba(76, 201, 240, 0.1)); }
    .animated-border::before { content: ''; position: absolute; top: -2px; left: -2px; right: -2px; bottom: -2px; background: linear-gradient(45deg, #f72585, #4cc9f0, #f72585, #4cc9f0); background-size: 400% 400%; border-radius: 18px; z-index: -1; animation: borderGlow 3s ease infinite; opacity: 0.6; }
    @keyframes borderGlow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    
    .progress-fill { background: linear-gradient(90deg, #f72585, #b5179e, #7209b7, #4cc9f0, #f72585); background-size: 300% 100%; animation: progressShine 2s linear infinite; }
    @keyframes progressShine { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    
    .bounce { animation: bounce 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
    @keyframes bounce { 0% { transform: scale(0); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
    
    .warning-pulse { animation: warningPulse 1s ease-in-out infinite; }
    @keyframes warningPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
    
    .neon-flicker { animation: flicker 4s infinite; }
    @keyframes flicker { 0%, 100% { opacity: 1; } 92% { opacity: 1; } 93% { opacity: 0.8; } 94% { opacity: 1; } 96% { opacity: 0.9; } 97% { opacity: 1; } }
    
    .ai-thinking { animation: aiThinking 1.5s ease-in-out infinite; }
    @keyframes aiThinking {
      0%, 100% { opacity: 0.5; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.05); }
    }
    
    .typing-dots span { animation: typingDot 1.4s infinite; opacity: 0; }
    .typing-dots span:nth-child(1) { animation-delay: 0s; }
    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typingDot { 0%, 60%, 100% { opacity: 0; } 30% { opacity: 1; } }
    
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: rgba(20, 10, 40, 0.5); }
    ::-webkit-scrollbar-thumb { background: rgba(247, 37, 133, 0.5); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(247, 37, 133, 0.7); }
    ::selection { background: rgba(247, 37, 133, 0.4); color: #fff; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    const Confetti = ({ active }) => {
      if (!active) return null;
      const colors = ['#f72585', '#b5179e', '#7209b7', '#4cc9f0', '#4361ee', '#3f37c9'];
      const pieces = Array.from({ length: 50 }, (_, i) => ({ id: i, left: Math.random() * 100, delay: Math.random() * 0.5, color: colors[Math.floor(Math.random() * colors.length)], size: Math.random() * 10 + 5 }));
      return (
        <div className="confetti">
          {pieces.map(piece => (<div key={piece.id} className="confetti-piece" style={{ left: `${piece.left}%`, animationDelay: `${piece.delay}s`, backgroundColor: piece.color, width: piece.size, height: piece.size, borderRadius: Math.random() > 0.5 ? '50%' : '0', boxShadow: `0 0 10px ${piece.color}` }} />))}
        </div>
      );
    };

    const Particles = () => {
      const particles = Array.from({ length: 25 }, (_, i) => ({ id: i, left: Math.random() * 100, delay: Math.random() * 20, duration: 15 + Math.random() * 10, size: 2 + Math.random() * 4, color: Math.random() > 0.5 ? 'pink' : 'blue' }));
      return (
        <div className="particles">
          {particles.map(p => (<div key={p.id} className={`particle particle-${p.color}`} style={{ left: `${p.left}%`, animationDelay: `${p.delay}s`, animationDuration: `${p.duration}s`, width: p.size, height: p.size }} />))}
        </div>
      );
    };

    // AI Loading Component
    const AIThinking = () => (
      <div style={{ textAlign: 'center', padding: '40px 20px' }}>
        <div style={{ fontSize: '48px', marginBottom: '20px' }} className="ai-thinking">üß†</div>
        <div style={{ fontSize: '18px', color: '#f72585', fontWeight: '700', marginBottom: '10px' }}>
          AI is analyzing your soul
          <span className="typing-dots">
            <span>.</span><span>.</span><span>.</span>
          </span>
        </div>
        <div style={{ fontSize: '14px', color: '#4cc9f0', opacity: 0.7 }}>
          Considering your preferences, history, and cosmic alignment
        </div>
      </div>
    );

    const DecideAlready = () => {
      const [selectedQuestion, setSelectedQuestion] = useState('');
      const [customQuestion, setCustomQuestion] = useState('');
      const [decision, setDecision] = useState('');
      const [phase, setPhase] = useState('loading');
      const [streak, setStreak] = useState(0);
      const [isLoading, setIsLoading] = useState(false);
      const [showCelebration, setShowCelebration] = useState(false);
      const [showConfetti, setShowConfetti] = useState(false);
      const [rerollAvailable, setRerollAvailable] = useState(true);
      const [onboardingStep, setOnboardingStep] = useState(0);
      const [shakeCard, setShakeCard] = useState(false);
      const [aiError, setAiError] = useState('');
      const [userProfile, setUserProfile] = useState({ 
        name: '', 
        dietaryRestrictions: [], 
        favoriteCuisines: [], 
        entertainmentLikes: [], 
        entertainmentDislikes: [], 
        personality: '', 
        chronotype: '', 
        fitnessLevel: '',
        mood: '',
        budget: '',
      });
      const [decisionHistory, setDecisionHistory] = useState([]); // Accepted decisions
      const [rejectedDecisions, setRejectedDecisions] = useState([]);
      const [showFeedback, setShowFeedback] = useState(false);
      const [feedbackReason, setFeedbackReason] = useState('');

      const questionOptions = [
        { id: 'eat', label: 'What should I eat?', icon: 'üçï' },
        { id: 'wear', label: 'What should I wear?', icon: 'üëï' },
        { id: 'goOut', label: 'Should I go out or stay in?', icon: 'üö™' },
        { id: 'watch', label: 'What should I watch?', icon: 'üì∫' },
        { id: 'text', label: 'Should I text them?', icon: 'üí¨' },
        { id: 'buy', label: 'Should I buy it?', icon: 'üí≥' },
        { id: 'workout', label: 'Should I workout?', icon: 'üí™' },
        { id: 'sleep', label: 'Should I stay up or go to sleep?', icon: 'üò¥' },
        { id: 'dating', label: 'Should I go on the date?', icon: '‚ù§Ô∏è' },
        { id: 'job', label: 'Should I apply for the job?', icon: 'üíº' },
        { id: 'custom', label: 'Ask anything...', icon: '‚ú®' },
      ];

      const onboardingQuestions = [
        { id: 'name', question: "What should I call you?", type: 'text', field: 'name' },
        { id: 'dietary', question: "Any foods you CAN'T or WON'T eat?", type: 'multiSelect', field: 'dietaryRestrictions', options: [{ id: 'vegetarian', label: 'ü•¨ Vegetarian' }, { id: 'vegan', label: 'üå± Vegan' }, { id: 'glutenFree', label: 'üåæ Gluten-Free' }, { id: 'dairyFree', label: 'ü•õ Dairy-Free' }, { id: 'halal', label: '‚ò™Ô∏è Halal' }, { id: 'kosher', label: '‚ú°Ô∏è Kosher' }, { id: 'seafood', label: 'üêü No Seafood' }, { id: 'spicy', label: 'üå∂Ô∏è No Spicy' }, { id: 'none', label: '‚úì No Restrictions' }] },
        { id: 'cuisines', question: "What cuisines do you LOVE?", type: 'multiSelect', field: 'favoriteCuisines', options: [{ id: 'italian', label: 'üçù Italian' }, { id: 'mexican', label: 'üåÆ Mexican' }, { id: 'chinese', label: 'ü•° Chinese' }, { id: 'japanese', label: 'üç£ Japanese' }, { id: 'indian', label: 'üçõ Indian' }, { id: 'thai', label: 'üçú Thai' }, { id: 'american', label: 'üçî American' }, { id: 'mediterranean', label: 'ü•ô Mediterranean' }, { id: 'korean', label: 'üç≤ Korean' }, { id: 'vietnamese', label: 'üç≤ Vietnamese' }] },
        { id: 'entertainment', question: "What do you like to watch?", type: 'multiSelect', field: 'entertainmentLikes', options: [{ id: 'comedy', label: 'üòÇ Comedy' }, { id: 'drama', label: 'üé≠ Drama' }, { id: 'action', label: 'üí• Action' }, { id: 'horror', label: 'üëª Horror' }, { id: 'documentary', label: 'üìö Documentary' }, { id: 'reality', label: 'üì∫ Reality TV' }, { id: 'scifi', label: 'üöÄ Sci-Fi' }, { id: 'romance', label: 'üíï Romance' }, { id: 'thriller', label: 'üò± Thriller' }, { id: 'anime', label: 'üéå Anime' }] },
        { id: 'entertainmentHate', question: "What do you NEVER want to watch?", type: 'multiSelect', field: 'entertainmentDislikes', options: [{ id: 'comedy', label: 'üòÇ Comedy' }, { id: 'drama', label: 'üé≠ Drama' }, { id: 'action', label: 'üí• Action' }, { id: 'horror', label: 'üëª Horror' }, { id: 'documentary', label: 'üìö Documentary' }, { id: 'reality', label: 'üì∫ Reality TV' }, { id: 'scifi', label: 'üöÄ Sci-Fi' }, { id: 'romance', label: 'üíï Romance' }, { id: 'none', label: '‚úì I watch anything' }] },
        { id: 'personality', question: "Social battery?", type: 'singleSelect', field: 'personality', options: [{ id: 'introvert', label: 'üè† Introvert - Recharging alone' }, { id: 'extrovert', label: 'üéâ Extrovert - Energized by people' }, { id: 'ambivert', label: '‚öñÔ∏è Ambivert - Depends on the day' }] },
        { id: 'chronotype', question: "When are you at your best?", type: 'singleSelect', field: 'chronotype', options: [{ id: 'earlyBird', label: 'üåÖ Early Bird - Morning person' }, { id: 'nightOwl', label: 'ü¶â Night Owl - Late night energy' }, { id: 'flexible', label: 'üîÑ Flexible - Whenever' }] },
        { id: 'fitness', question: "Fitness level?", type: 'singleSelect', field: 'fitnessLevel', options: [{ id: 'beginner', label: 'üå± Just starting out' }, { id: 'intermediate', label: 'üí™ Regular exerciser' }, { id: 'advanced', label: 'üèÜ Fitness enthusiast' }, { id: 'rest', label: 'üò¥ Currently on a break' }] },
        { id: 'budget', question: "Typical spending vibe?", type: 'singleSelect', field: 'budget', options: [{ id: 'frugal', label: 'üí∞ Frugal - Save where I can' }, { id: 'moderate', label: '‚öñÔ∏è Moderate - Balance is key' }, { id: 'splurge', label: 'üí∏ Treat yourself - Life is short' }] },
      ];

      const feedbackReasons = [
        { id: 'dietary', label: "üö´ Can't do that (restriction)" },
        { id: 'dontLike', label: "üëé I don't like this" },
        { id: 'notInMood', label: "üòê Not in the mood today" },
        { id: 'tooExpensive', label: "üí∏ Too expensive" },
        { id: 'notAvailable', label: "‚ùå Not available to me" },
        { id: 'tooHard', label: "üòì Too difficult right now" },
        { id: 'other', label: "ü§∑ Other reason" },
      ];

      useEffect(() => {
        const savedProfile = localStorage.getItem('decideAlreadyProfile');
        const savedStreak = localStorage.getItem('decideAlreadyStreak');
        const savedRejections = localStorage.getItem('decideAlreadyRejections');
        const savedHistory = localStorage.getItem('decideAlreadyHistory');
        const lastRerollDate = localStorage.getItem('decideAlreadyRerollDate');
        if (savedStreak) setStreak(parseInt(savedStreak));
        if (savedRejections) setRejectedDecisions(JSON.parse(savedRejections));
        if (savedHistory) setDecisionHistory(JSON.parse(savedHistory));
        const today = new Date().toDateString();
        if (lastRerollDate === today) setRerollAvailable(false);
        if (savedProfile) { setUserProfile(JSON.parse(savedProfile)); setPhase('ask'); } else { setPhase('onboarding'); }
      }, []);

      // AI Decision Generator using Claude API
      const getAIDecision = async (questionType, questionLabel) => {
        const currentHour = new Date().getHours();
        const timeOfDay = currentHour < 12 ? 'morning' : currentHour < 17 ? 'afternoon' : currentHour < 21 ? 'evening' : 'late night';
        const dayOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][new Date().getDay()];
        
        // Get recent history for this category
        const categoryHistory = decisionHistory.filter(h => h.category === questionType).slice(-5);
        const categoryRejections = rejectedDecisions.filter(r => r.category === questionType).slice(-5);
        
        const prompt = `You are DecideAlready, a bold, no-nonsense decision-making AI. Your job is to give ONE clear, specific, actionable decision. No hedging. No "it depends." Just tell them what to do.

USER PROFILE:
- Name: ${userProfile.name || 'Friend'}
- Personality: ${userProfile.personality || 'unknown'}
- Time preference: ${userProfile.chronotype || 'flexible'}
- Fitness level: ${userProfile.fitnessLevel || 'moderate'}
- Budget: ${userProfile.budget || 'moderate'}
${userProfile.dietaryRestrictions?.length ? `- Dietary restrictions: ${userProfile.dietaryRestrictions.join(', ')}` : ''}
${userProfile.favoriteCuisines?.length ? `- Favorite cuisines: ${userProfile.favoriteCuisines.join(', ')}` : ''}
${userProfile.entertainmentLikes?.length ? `- Entertainment likes: ${userProfile.entertainmentLikes.join(', ')}` : ''}
${userProfile.entertainmentDislikes?.length ? `- Entertainment dislikes: ${userProfile.entertainmentDislikes.join(', ')}` : ''}

CONTEXT:
- Current time: ${timeOfDay} on ${dayOfWeek}
- Current streak: ${streak} decisions followed
${categoryHistory.length ? `- Recent decisions they FOLLOWED for this category: ${categoryHistory.map(h => h.decision).join('; ')}` : ''}
${categoryRejections.length ? `- Decisions they REJECTED (and why): ${categoryRejections.map(r => `"${r.decision}" - ${r.reason}`).join('; ')}` : ''}

THE QUESTION: "${questionLabel}"
${questionType === 'custom' ? `(Custom question from user)` : ''}

RULES:
1. Give ONE specific answer (not a list of options)
2. Be direct and confident - no "maybe" or "perhaps"
3. Keep it to 1-2 sentences max
4. Add a tiny bit of personality/humor
5. Consider their profile, time of day, and past rejections
6. NEVER suggest something they've already rejected
7. If they've been accepting similar things, maybe suggest something slightly different
8. Match their energy (introvert = calmer suggestions, extrovert = bolder)

Respond with ONLY the decision text. No quotes, no "I think", just the decision.`;

        try {
          const response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              model: 'claude-sonnet-4-20250514',
              max_tokens: 150,
              messages: [{ role: 'user', content: prompt }]
            })
          });

          if (!response.ok) {
            throw new Error(`API error: ${response.status}`);
          }

          const data = await response.json();
          return data.content[0].text.trim();
        } catch (error) {
          console.error('AI Error:', error);
          throw error;
        }
      };

      const handleOnboardingNext = () => { 
        if (onboardingStep < onboardingQuestions.length - 1) { 
          setOnboardingStep(onboardingStep + 1); 
        } else { 
          localStorage.setItem('decideAlreadyProfile', JSON.stringify(userProfile)); 
          setPhase('ask'); 
        } 
      };
      
      const handleOnboardingSelect = (field, value, isMulti) => { 
        if (isMulti) { 
          const current = userProfile[field] || []; 
          if (value === 'none') { 
            setUserProfile({ ...userProfile, [field]: [] }); 
          } else if (current.includes(value)) { 
            setUserProfile({ ...userProfile, [field]: current.filter(v => v !== value) }); 
          } else { 
            setUserProfile({ ...userProfile, [field]: [...current.filter(v => v !== 'none'), value] }); 
          } 
        } else { 
          setUserProfile({ ...userProfile, [field]: value }); 
        } 
      };
      
      const handleCommit = () => { 
        if (!selectedQuestion) return; 
        if (selectedQuestion === 'custom' && !customQuestion.trim()) return;
        setShakeCard(true); 
        setTimeout(() => setShakeCard(false), 500); 
        setPhase('commit'); 
      };
      
      const handleReveal = async () => { 
        setIsLoading(true);
        setAiError('');
        
        try {
          const questionLabel = selectedQuestion === 'custom' 
            ? customQuestion 
            : questionOptions.find(q => q.id === selectedQuestion)?.label;
          
          const aiDecision = await getAIDecision(selectedQuestion, questionLabel);
          setDecision(aiDecision);
          setPhase('reveal');
        } catch (error) {
          setAiError('AI had a moment. Tap to try again.');
          setPhase('commit');
        } finally {
          setIsLoading(false);
        }
      };
      
      const handleFollowed = () => { 
        const newStreak = streak + 1; 
        setStreak(newStreak); 
        localStorage.setItem('decideAlreadyStreak', newStreak.toString());
        
        // Save to decision history
        const newHistory = [...decisionHistory, {
          category: selectedQuestion,
          question: selectedQuestion === 'custom' ? customQuestion : getSelectedLabel(),
          decision,
          timestamp: new Date().toISOString(),
          followed: true
        }].slice(-50); // Keep last 50
        setDecisionHistory(newHistory);
        localStorage.setItem('decideAlreadyHistory', JSON.stringify(newHistory));
        
        setShowCelebration(true); 
        setShowConfetti(true); 
        setTimeout(() => { 
          setShowCelebration(false); 
          setShowConfetti(false); 
          resetApp(); 
        }, 3000); 
      };
      
      const handleReroll = async () => { 
        if (!rerollAvailable) return; 
        localStorage.setItem('decideAlreadyRerollDate', new Date().toDateString()); 
        setRerollAvailable(false); 
        setIsLoading(true);
        setAiError('');
        
        try {
          const questionLabel = selectedQuestion === 'custom' 
            ? customQuestion 
            : questionOptions.find(q => q.id === selectedQuestion)?.label;
          
          const aiDecision = await getAIDecision(selectedQuestion, questionLabel);
          setDecision(aiDecision);
        } catch (error) {
          setAiError('AI stumbled. That was your last reroll though!');
        } finally {
          setIsLoading(false);
        }
      };
      
      const handleBroken = () => setShowFeedback(true);
      
      const handleFeedbackSubmit = () => { 
        const updated = [...rejectedDecisions, { 
          category: selectedQuestion, 
          question: selectedQuestion === 'custom' ? customQuestion : getSelectedLabel(),
          decision, 
          reason: feedbackReason, 
          timestamp: new Date().toISOString() 
        }].slice(-30); // Keep last 30 rejections
        setRejectedDecisions(updated); 
        localStorage.setItem('decideAlreadyRejections', JSON.stringify(updated)); 
        setStreak(0); 
        localStorage.setItem('decideAlreadyStreak', '0'); 
        setShowFeedback(false); 
        setFeedbackReason(''); 
        resetApp(); 
      };
      
      const handleSkipFeedback = () => { 
        setStreak(0); 
        localStorage.setItem('decideAlreadyStreak', '0'); 
        setShowFeedback(false); 
        setFeedbackReason(''); 
        resetApp(); 
      };
      
      const resetApp = () => { 
        setSelectedQuestion(''); 
        setCustomQuestion('');
        setDecision(''); 
        setAiError('');
        setPhase('ask'); 
      };
      
      const handleShare = () => { 
        const questionText = selectedQuestion === 'custom' ? customQuestion : questionOptions.find(q => q.id === selectedQuestion)?.label;
        const text = `I asked DecideAlready AI: "${questionText}"\n\nThe verdict: ${decision}\n\n‚ö° ${streak} decision streak\n\nStop overthinking. Let the AI decide.`; 
        if (navigator.share) { navigator.share({ text }); } else { navigator.clipboard.writeText(text); alert('Copied to clipboard!'); } 
      };
      
      const getSelectedLabel = () => {
        if (selectedQuestion === 'custom') return customQuestion;
        return questionOptions.find(q => q.id === selectedQuestion)?.label || '';
      };
      
      const resetProfile = () => { 
        localStorage.removeItem('decideAlreadyProfile'); 
        localStorage.removeItem('decideAlreadyRejections');
        localStorage.removeItem('decideAlreadyHistory');
        setUserProfile({ name: '', dietaryRestrictions: [], favoriteCuisines: [], entertainmentLikes: [], entertainmentDislikes: [], personality: '', chronotype: '', fitnessLevel: '', budget: '' }); 
        setRejectedDecisions([]); 
        setDecisionHistory([]);
        setOnboardingStep(0); 
        setPhase('onboarding'); 
      };

      const s = {
        container: { minHeight: '100vh', fontFamily: '"Space Grotesk", sans-serif', color: '#fff', padding: '20px', position: 'relative', overflow: 'hidden' },
        celebration: { position: 'fixed', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', fontSize: '48px', fontWeight: '900', color: '#f72585', zIndex: 1000, background: 'rgba(13, 0, 21, 0.95)', padding: '40px 60px', borderRadius: '24px', border: '2px solid #f72585', textAlign: 'center' },
        header: { textAlign: 'center', marginBottom: '20px', paddingTop: '20px', position: 'relative', zIndex: 1 },
        logo: { fontSize: '42px', fontWeight: '900', margin: 0, letterSpacing: '-2px', textTransform: 'uppercase', color: '#fff' },
        logoAccent: { color: '#f72585', display: 'block', fontSize: '52px', lineHeight: '1' },
        tagline: { fontSize: '14px', color: '#4cc9f0', marginTop: '10px', letterSpacing: '3px', textTransform: 'uppercase' },
        aiBadge: { display: 'inline-flex', alignItems: 'center', gap: '6px', background: 'linear-gradient(135deg, rgba(247, 37, 133, 0.2), rgba(76, 201, 240, 0.2))', border: '1px solid rgba(247, 37, 133, 0.3)', borderRadius: '20px', padding: '6px 14px', fontSize: '11px', letterSpacing: '2px', color: '#4cc9f0', marginTop: '10px' },
        progressBar: { width: '100%', maxWidth: '500px', height: '6px', background: 'rgba(255,255,255,0.1)', borderRadius: '3px', margin: '0 auto 30px', overflow: 'hidden' },
        streakContainer: { display: 'flex', justifyContent: 'center', marginBottom: '30px', position: 'relative', zIndex: 1 },
        streak: { display: 'flex', alignItems: 'center', gap: '10px', background: 'rgba(76, 201, 240, 0.1)', border: '2px solid rgba(76, 201, 240, 0.4)', borderRadius: '50px', padding: '12px 28px' },
        streakFire: { fontSize: '28px' },
        streakNumber: { fontSize: '36px', fontWeight: '900', color: '#4cc9f0' },
        streakLabel: { fontSize: '12px', color: '#4cc9f0', letterSpacing: '2px', opacity: 0.8 },
        card: { borderRadius: '24px', padding: '40px 30px', maxWidth: '500px', margin: '0 auto', position: 'relative', zIndex: 1 },
        label: { fontSize: '12px', letterSpacing: '3px', color: '#4cc9f0', textAlign: 'center', marginBottom: '20px' },
        optionsGrid: { display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '12px' },
        optionButton: { display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '8px', padding: '18px 12px', background: 'rgba(247, 37, 133, 0.05)', border: '2px solid rgba(247, 37, 133, 0.2)', borderRadius: '16px', cursor: 'pointer', fontFamily: 'inherit', color: '#fff' },
        optionButtonSelected: { background: 'rgba(247, 37, 133, 0.2)', borderColor: '#f72585', boxShadow: '0 0 30px rgba(247, 37, 133, 0.3), inset 0 0 30px rgba(247, 37, 133, 0.05)' },
        optionButtonWide: { gridColumn: 'span 2' },
        optionIcon: { fontSize: '32px' },
        optionText: { fontSize: '13px', color: '#fff', textAlign: 'center', lineHeight: '1.3' },
        button: { padding: '18px 32px', fontSize: '16px', fontWeight: '700', borderRadius: '14px', border: 'none', cursor: 'pointer', letterSpacing: '1px', fontFamily: 'inherit', width: '100%' },
        buttonPrimary: { background: 'linear-gradient(135deg, #f72585 0%, #b5179e 100%)', color: '#fff' },
        buttonDisabled: { opacity: 0.5, cursor: 'not-allowed' },
        buttonDanger: { background: 'linear-gradient(135deg, #7209b7 0%, #3a0ca3 100%)', color: '#fff' },
        buttonGhost: { background: 'transparent', border: '1px solid rgba(76, 201, 240, 0.3)', color: '#4cc9f0', fontSize: '14px', marginTop: '10px' },
        buttonSuccess: { background: 'linear-gradient(135deg, #4cc9f0 0%, #4895ef 100%)', color: '#0d0015', flex: 1, fontWeight: '800' },
        buttonFail: { background: 'transparent', border: '2px solid #f72585', color: '#f72585', flex: 1 },
        buttonShare: { background: 'rgba(76, 201, 240, 0.1)', border: '1px solid rgba(76, 201, 240, 0.3)', color: '#4cc9f0', marginTop: '10px' },
        buttonReroll: { background: 'transparent', border: '2px solid #b5179e', color: '#b5179e', marginTop: '10px' },
        rerollUsed: { fontSize: '14px', color: '#f72585', fontStyle: 'italic', padding: '12px', background: 'rgba(247, 37, 133, 0.1)', borderRadius: '12px', marginTop: '10px', textAlign: 'center' },
        warningIcon: { fontSize: '72px', textAlign: 'center' },
        commitTitle: { fontSize: '42px', fontWeight: '900', margin: 0, color: '#f72585', textAlign: 'center' },
        commitText: { fontSize: '18px', color: 'rgba(255,255,255,0.7)', margin: 0, lineHeight: '1.6', textAlign: 'center' },
        bold: { color: '#4cc9f0', fontWeight: '700' },
        questionPreview: { background: 'rgba(247, 37, 133, 0.1)', border: '1px solid rgba(247, 37, 133, 0.3)', borderRadius: '12px', padding: '15px 20px', fontSize: '16px', fontStyle: 'italic', color: '#f72585', margin: '10px 0', textAlign: 'center' },
        verdictLabel: { fontSize: '12px', letterSpacing: '4px', color: '#4cc9f0', textAlign: 'center' },
        decision: { fontSize: '24px', fontWeight: '700', lineHeight: '1.5', color: '#fff', padding: '24px', background: 'linear-gradient(135deg, rgba(247, 37, 133, 0.15) 0%, rgba(76, 201, 240, 0.1) 100%)', borderRadius: '16px', border: '2px solid rgba(247, 37, 133, 0.3)', textAlign: 'center' },
        questionReminder: { fontSize: '14px', color: 'rgba(76, 201, 240, 0.7)', fontStyle: 'italic', textAlign: 'center' },
        actionButtons: { display: 'flex', gap: '15px', marginTop: '10px' },
        footer: { textAlign: 'center', marginTop: '40px', padding: '20px', position: 'relative', zIndex: 1 },
        footerText: { fontSize: '14px', color: 'rgba(76, 201, 240, 0.5)', fontStyle: 'italic' },
        resetButton: { marginTop: '15px', background: 'transparent', border: 'none', color: 'rgba(247, 37, 133, 0.5)', fontSize: '12px', cursor: 'pointer', textDecoration: 'underline', fontFamily: 'inherit' },
        onboardingQuestion: { fontSize: '26px', fontWeight: '700', textAlign: 'center', marginBottom: '25px', color: '#fff' },
        textInput: { width: '100%', padding: '18px 20px', fontSize: '18px', background: 'rgba(247, 37, 133, 0.05)', border: '2px solid rgba(247, 37, 133, 0.2)', borderRadius: '14px', color: '#fff', outline: 'none', fontFamily: 'inherit', boxSizing: 'border-box' },
        customInput: { width: '100%', padding: '16px 18px', fontSize: '16px', background: 'rgba(247, 37, 133, 0.05)', border: '2px solid rgba(247, 37, 133, 0.3)', borderRadius: '14px', color: '#fff', outline: 'none', fontFamily: 'inherit', boxSizing: 'border-box', marginTop: '15px' },
        onboardingOptions: { display: 'flex', flexWrap: 'wrap', gap: '10px', justifyContent: 'center', marginBottom: '20px' },
        onboardingOption: { padding: '12px 18px', background: 'rgba(247, 37, 133, 0.05)', border: '2px solid rgba(247, 37, 133, 0.2)', borderRadius: '25px', color: '#fff', fontSize: '14px', cursor: 'pointer', fontFamily: 'inherit' },
        onboardingOptionsSingle: { display: 'flex', flexDirection: 'column', gap: '10px', marginBottom: '20px' },
        onboardingOptionSingle: { padding: '16px 20px', background: 'rgba(247, 37, 133, 0.05)', border: '2px solid rgba(247, 37, 133, 0.2)', borderRadius: '14px', color: '#fff', fontSize: '16px', cursor: 'pointer', fontFamily: 'inherit', textAlign: 'left' },
        onboardingOptionSelected: { background: 'rgba(247, 37, 133, 0.2)', borderColor: '#f72585', boxShadow: '0 0 20px rgba(247, 37, 133, 0.3)' },
        feedbackTitle: { fontSize: '26px', fontWeight: '700', textAlign: 'center', marginBottom: '10px', color: '#fff' },
        feedbackSubtitle: { fontSize: '14px', color: 'rgba(76, 201, 240, 0.7)', textAlign: 'center', marginBottom: '20px' },
        feedbackDecision: { background: 'rgba(247, 37, 133, 0.1)', border: '1px solid rgba(247, 37, 133, 0.3)', borderRadius: '12px', padding: '15px', fontSize: '16px', fontStyle: 'italic', color: '#f72585', marginBottom: '20px', textAlign: 'center' },
        feedbackOptions: { display: 'flex', flexDirection: 'column', gap: '10px', marginBottom: '20px' },
        feedbackOption: { padding: '14px 18px', background: 'rgba(247, 37, 133, 0.05)', border: '2px solid rgba(247, 37, 133, 0.2)', borderRadius: '12px', color: '#fff', fontSize: '15px', cursor: 'pointer', fontFamily: 'inherit', textAlign: 'left' },
        feedbackOptionSelected: { background: 'rgba(247, 37, 133, 0.2)', borderColor: '#f72585' },
        errorText: { color: '#f72585', fontSize: '14px', textAlign: 'center', padding: '10px', background: 'rgba(247, 37, 133, 0.1)', borderRadius: '8px', marginTop: '10px' },
        statsContainer: { display: 'flex', justifyContent: 'center', gap: '20px', marginTop: '15px', fontSize: '12px', color: 'rgba(76, 201, 240, 0.6)' },
      };

      if (phase === 'onboarding') {
        const currentQ = onboardingQuestions[onboardingStep];
        return (
          <div style={s.container} className="animated-bg">
            <Particles />
            <div style={s.header}>
              <h1 style={s.logo}>DECIDE<span style={s.logoAccent} className="glow-text neon-flicker">ALREADY</span></h1>
              <div style={s.aiBadge}>üß† AI-POWERED</div>
              <p style={s.tagline} className="glow-text-blue">Let's get to know you</p>
            </div>
            <div style={s.progressBar}><div className="progress-fill" style={{height: '100%', width: `${((onboardingStep + 1) / onboardingQuestions.length) * 100}%`, borderRadius: '3px'}} /></div>
            <div style={s.card} className="glass-card card-enter">
              <h2 style={s.onboardingQuestion}>{currentQ.question}</h2>
              {currentQ.type === 'text' && <input type="text" style={s.textInput} placeholder="Enter your name..." value={userProfile[currentQ.field] || ''} onChange={(e) => setUserProfile({...userProfile, [currentQ.field]: e.target.value})} />}
              {currentQ.type === 'multiSelect' && <div style={s.onboardingOptions}>{currentQ.options.map(opt => <button key={opt.id} className="option-btn" style={{...s.onboardingOption, ...(userProfile[currentQ.field]?.includes(opt.id) ? s.onboardingOptionSelected : {})}} onClick={() => handleOnboardingSelect(currentQ.field, opt.id, true)}>{opt.label}</button>)}</div>}
              {currentQ.type === 'singleSelect' && <div style={s.onboardingOptionsSingle}>{currentQ.options.map(opt => <button key={opt.id} className="option-btn" style={{...s.onboardingOptionSingle, ...(userProfile[currentQ.field] === opt.id ? s.onboardingOptionSelected : {})}} onClick={() => handleOnboardingSelect(currentQ.field, opt.id, false)}>{opt.label}</button>)}</div>}
              <button className="btn-hover glow-pink" style={{...s.button, ...s.buttonPrimary}} onClick={handleOnboardingNext}>{onboardingStep < onboardingQuestions.length - 1 ? 'NEXT ‚Üí' : "LET'S GO ‚ö°"}</button>
              {onboardingStep > 0 && <button className="btn-hover" style={{...s.button, ...s.buttonGhost}} onClick={() => setOnboardingStep(onboardingStep - 1)}>‚Üê Back</button>}
            </div>
          </div>
        );
      }

      if (showFeedback) {
        return (
          <div style={s.container} className="animated-bg">
            <Particles />
            <div style={s.header}><h1 style={s.logo}>DECIDE<span style={s.logoAccent} className="glow-text neon-flicker">ALREADY</span></h1></div>
            <div style={s.card} className="glass-card card-enter">
              <h2 style={s.feedbackTitle}>Why didn't you do it?</h2>
              <p style={s.feedbackSubtitle}>Help the AI learn so it doesn't suggest this again</p>
              <div style={s.feedbackDecision}>"{decision}"</div>
              <div style={s.feedbackOptions}>{feedbackReasons.map(r => <button key={r.id} className="option-btn" style={{...s.feedbackOption, ...(feedbackReason === r.id ? s.feedbackOptionSelected : {})}} onClick={() => setFeedbackReason(r.id)}>{r.label}</button>)}</div>
              <button className="btn-hover" style={{...s.button, ...s.buttonDanger, ...(feedbackReason ? {} : s.buttonDisabled)}} onClick={handleFeedbackSubmit} disabled={!feedbackReason}>SUBMIT & RESET STREAK</button>
              <button className="btn-hover" style={{...s.button, ...s.buttonGhost}} onClick={handleSkipFeedback}>Skip (just reset streak)</button>
            </div>
          </div>
        );
      }

      return (
        <div style={s.container} className="animated-bg">
          <Particles />
          <Confetti active={showConfetti} />
          {showCelebration && <div style={s.celebration} className="celebration-overlay glow-pink"><div style={{fontSize: '64px', marginBottom: '10px'}}>‚ö°</div><div className="glow-text">STREAK: {streak}</div><div style={{fontSize: '18px', color: '#4cc9f0', marginTop: '10px'}}>You're electric!</div></div>}
          <div style={s.header}>
            <h1 style={s.logo}>DECIDE<span style={s.logoAccent} className="glow-text neon-flicker">ALREADY</span></h1>
            <div style={s.aiBadge}>üß† AI-POWERED</div>
            <p style={s.tagline} className="glow-text-blue">{userProfile.name ? `${userProfile.name}, stop thinking. Start doing.` : 'Stop thinking. Start doing.'}</p>
          </div>
          <div style={s.streakContainer}><div style={s.streak} className="streak-glow"><span style={s.streakFire} className={streak > 0 ? 'bounce' : ''}>‚ö°</span><span style={s.streakNumber}>{streak}</span><span style={s.streakLabel}>STREAK</span></div></div>
          <div style={s.card} className={`glass-card card-enter ${shakeCard ? 'shake' : ''}`}>
            {phase === 'ask' && (
              <div>
                <div style={s.label}>WHAT CAN'T YOU DECIDE?</div>
                <div style={s.optionsGrid}>
                  {questionOptions.map(opt => (
                    <button 
                      key={opt.id} 
                      className="option-btn" 
                      style={{
                        ...s.optionButton, 
                        ...(selectedQuestion === opt.id ? s.optionButtonSelected : {}),
                        ...(opt.id === 'custom' ? s.optionButtonWide : {})
                      }} 
                      onClick={() => setSelectedQuestion(opt.id)}
                    >
                      <span style={s.optionIcon} className={selectedQuestion === opt.id ? 'bounce' : ''}>{opt.icon}</span>
                      <span style={s.optionText}>{opt.label}</span>
                    </button>
                  ))}
                </div>
                {selectedQuestion === 'custom' && (
                  <input 
                    type="text" 
                    style={s.customInput} 
                    placeholder="Type your question..." 
                    value={customQuestion}
                    onChange={(e) => setCustomQuestion(e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && handleCommit()}
                  />
                )}
                <button 
                  className={`btn-hover ${(selectedQuestion && (selectedQuestion !== 'custom' || customQuestion.trim())) ? 'glow-pink' : ''}`} 
                  style={{
                    ...s.button, 
                    ...s.buttonPrimary, 
                    marginTop: '20px', 
                    ...((selectedQuestion && (selectedQuestion !== 'custom' || customQuestion.trim())) ? {} : s.buttonDisabled)
                  }} 
                  onClick={handleCommit} 
                  disabled={!selectedQuestion || (selectedQuestion === 'custom' && !customQuestion.trim())}
                >
                  I NEED AN ANSWER
                </button>
                <div style={s.statsContainer}>
                  <span>üìä {decisionHistory.length} decisions made</span>
                  <span>üß† {rejectedDecisions.length} lessons learned</span>
                </div>
              </div>
            )}
            
            {phase === 'commit' && !isLoading && (
              <div>
                <div style={s.warningIcon} className="warning-pulse">‚ö†Ô∏è</div>
                <h2 style={s.commitTitle} className="glow-text">WAIT.</h2>
                <p style={s.commitText}>Once you see the answer, you <span style={s.bold}>MUST</span> do it.</p>
                <p style={s.commitText}>No backing out. No excuses. No "but actually..."</p>
                <div style={s.questionPreview}>"{getSelectedLabel()}"</div>
                {aiError && <div style={s.errorText}>{aiError}</div>}
                <button className="btn-hover glow-pink" style={{...s.button, ...s.buttonDanger}} onClick={handleReveal}>
                  I COMMIT. SHOW ME.
                </button>
                <button className="btn-hover" style={{...s.button, ...s.buttonGhost}} onClick={resetApp}>I'm not ready (coward)</button>
              </div>
            )}
            
            {phase === 'commit' && isLoading && <AIThinking />}
            
            {phase === 'reveal' && (
              <div>
                <div style={s.verdictLabel}>üß† AI VERDICT ‚ú®</div>
                <div style={s.decision} className="reveal-text animated-border">{decision}</div>
                <div style={s.questionReminder}>You asked: "{getSelectedLabel()}"</div>
                {rerollAvailable && !isLoading && <button className="btn-hover" style={{...s.button, ...s.buttonReroll}} onClick={handleReroll}>üé≤ ASK AI AGAIN (1 per day)</button>}
                {!rerollAvailable && <div style={s.rerollUsed}>No more re-rolls today. Commit or fail.</div>}
                {isLoading && <div style={{...s.rerollUsed, color: '#b5179e'}} className="pulse">üß† AI is reconsidering...</div>}
                {aiError && <div style={s.errorText}>{aiError}</div>}
                <div style={s.actionButtons}>
                  <button className="btn-hover glow-blue" style={{...s.button, ...s.buttonSuccess}} onClick={handleFollowed}>‚ö° I DID IT</button>
                  <button className="btn-hover" style={{...s.button, ...s.buttonFail}} onClick={handleBroken}>‚úó I FAILED</button>
                </div>
                <button className="btn-hover" style={{...s.button, ...s.buttonShare}} onClick={handleShare}>üì§ SHARE MY DECISION</button>
              </div>
            )}
          </div>
          <div style={s.footer}>
            <p style={s.footerText}>
              {streak === 0 && "Make your first decision. Build your streak."}
              {streak > 0 && streak < 5 && "You're building momentum. Keep going."}
              {streak >= 5 && streak < 10 && "You're a decision machine now."}
              {streak >= 10 && "‚ö° UNSTOPPABLE. You've mastered your mind. ‚ö°"}
            </p>
            <button style={s.resetButton} onClick={resetProfile}>Reset Profile & AI Memory</button>
          </div>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<DecideAlready />);
  </script>
</body>
</html>
